<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCXnhsPcqTKsZbHxU67KEmm8FwHA1LhpPo",
        authDomain: "tagm-48ee0.firebaseapp.com",
        databaseURL: "https://tagm-48ee0-default-rtdb.firebaseio.com",
        projectId: "tagm-48ee0"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const params = new URLSearchParams(window.location.search);
    const currentId = params.get('id');
    const statusDiv = document.getElementById('status');
    
    let preloadedAudio = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ –≤ –ø–∞–º—è—Ç–∏

    // --- –§–£–ù–ö–¶–ò–Ø –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ò (–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É) ---
    if (currentId) {
        statusDiv.innerHTML = `–ú–µ—Ç–∫–∞: <b>${currentId}</b><br>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–≤—É–∫–∞...`;
        
        // –°—Ä–∞–∑—É –ª–µ–∑–µ–º –≤ –±–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –∫–ª–∏–∫–∞
        database.ref('tags/' + currentId).once('value').then(snap => {
            const val = snap.val();
            if (val && val.soundUrl && val.soundUrl !== "placeholder") {
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∞—É–¥–∏–æ –∏ –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ –≤ —Ñ–æ–Ω
                preloadedAudio = new Audio(val.soundUrl);
                preloadedAudio.preload = "auto"; 
                preloadedAudio.load(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –∫—ç—à
                
                statusDiv.innerHTML = `–ú–µ—Ç–∫–∞: <b>${currentId}</b><br>üöÄ –ì–û–¢–û–í! –ñ–º–∏!`;
            } else {
                statusDiv.innerHTML = "‚ùå –ó–≤—É–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –±–æ—Ç–µ";
            }
        });
    } else {
        statusDiv.innerHTML = `ID –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω<br>–°—á–∏—Ç–∞–π—Ç–µ NFC –º–µ—Ç–∫—É`;
    }

    // --- –ö–õ–ò–ö (–¢–µ–ø–µ—Ä—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ) ---
    document.getElementById('playBtn').onclick = () => {
        if (preloadedAudio) {
            // –§–∞–π–ª —É–∂–µ –≤ –ø–∞–º—è—Ç–∏, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–Ω–µ—Ç—Å—è –∑–∞ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
            preloadedAudio.currentTime = 0; // –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
            preloadedAudio.play().catch(e => {
                statusDiv.innerText = "–û—à–∏–±–∫–∞: –Ω–∞–∂–º–∏ –µ—â–µ —Ä–∞–∑";
            });
            statusDiv.innerText = "üîä –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï";
        } else {
            if (!currentId) return alert("–ù–µ—Ç ID!");
            statusDiv.innerText = "‚è≥ –§–∞–π–ª –µ—â–µ –≥—Ä—É–∑–∏—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏ —Å–µ–∫—É–Ω–¥—É...";
        }
    };

    // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function openModal() { document.getElementById('modal').style.display = 'block'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function saveTag() {
        const id = document.getElementById('tagInput').value;
        if (!/^\d{8}$/.test(id)) return alert("–ù—É–∂–Ω–æ 8 —Ü–∏—Ñ—Ä!");
        database.ref('tags/' + id).set({
            soundUrl: "placeholder",
            date: new Date().toLocaleDateString()
        }).then(() => {
            const finalLink = window.location.origin + "/?id=" + id;
            const resDiv = document.getElementById('result');
            resDiv.style.display = 'block';
            resDiv.innerHTML = `‚úÖ –°–æ–∑–¥–∞–Ω–æ!<br>–ó–∞–ø–∏—Å–∞—Ç—å –≤ NFC:<br><b>${finalLink}</b>`;
        });
    }
</script>
